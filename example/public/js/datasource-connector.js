!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("DatasourceConector",[],e):"object"==typeof exports?exports.DatasourceConector=e():t.DatasourceConector=e()}(window,function(){return function(t){var e={};function o(s){if(e[s])return e[s].exports;var r=e[s]={i:s,l:!1,exports:{}};return t[s].call(r.exports,r,r.exports,o),r.l=!0,r.exports}return o.m=t,o.c=e,o.d=function(t,e,s){o.o(t,e)||Object.defineProperty(t,e,{configurable:!1,enumerable:!0,get:s})},o.r=function(t){Object.defineProperty(t,"__esModule",{value:!0})},o.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return o.d(e,"a",e),e},o.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},o.p="",o(o.s=0)}([function(t,e,o){"use strict";o.r(e);class s{constructor(t){this.object=t}_serialie(t,e){let o,s=[];for(o in t)if(t.hasOwnProperty(o)){let r=e?e+"["+o+"]":o,n=t[o];s.push(null!==n&&"object"==typeof n?this._serialie(n,r):encodeURIComponent(r)+"="+encodeURIComponent(n))}return s.join("&")}string(){return void 0===this.object?"":"?"+this._serialie(this.object)}}class r{constructor(){this.url="",this.method="GET",this.headers={"Content-Type":"application/json"},this.body=""}}class n{constructor(t){this.controllerUrl=t,this.listeners=[]}addListener(t){"function"==typeof t&&this.listeners.push(t)}onDataSend(...t){this.listeners&&this.listeners.length&&this.listeners.forEach(e=>{e(...t)})}post(t,e){let o=new r;return o.url=this.controllerUrl+t,o.method="POST",o.body=JSON.stringify(e),this.request(o).then(t=>(this.onDataSend({request:o,response:JSON.parse(t)}),JSON.parse(t)))}get(t){var e=new r;return e.url=this.controllerUrl+t,this.request(e).then(t=>(this.onDataSend({request:e,response:JSON.parse(t)}),JSON.parse(t)))}request(t){return new Promise((e,o)=>{let s=new XMLHttpRequest;s.open(t.method||"GET",t.url),t.headers&&Object.keys(t.headers).forEach(e=>{s.setRequestHeader(e,t.headers[e])}),s.onload=(()=>{s.status>=200&&s.status<300?e(s.response):o(s.statusText)}),s.onerror=(()=>o(s.statusText)),s.send(t.body)})}}class i extends Handsontable.plugins.BasePlugin{constructor(t){super(t),this.http={},this.colHeaders=[],this.filters={},this.order={}}isEnabled(){let t=!!this.hot.getSettings().dataSourceConnector;if(t){let t=this.hot.getSettings().dataSourceConnector.controllerUrl,e=this.hot.getSettings().dataSourceConnector.onDataSend;this.http=new n(t),this.http.addListener(e)}return t}enablePlugin(){this.addHook("beforeColumnSort",()=>!1),this.addHook("beforeFilter",()=>!1),this.addHook("afterRender",t=>{}),this.addHook("afterInit",()=>this.onAfterInit()),this.addHook("afterChange",(t,e)=>this.onAfterChange(t,e)),this.addHook("afterColumnSort",(t,e)=>this.onAfterColumnSort(t,e)),this.addHook("afterCreateRow",(t,e,o)=>this.onAfterCreateRow(t,e,o)),this.addHook("afterCreateCol",(t,e,o)=>this.onAfterCreateCol(t,e,o)),this.addHook("afterColumnMove",(t,e)=>this.onAfterColumnMove(t,e)),this.addHook("afterFilter",t=>this.onAfterFilter(t)),super.enablePlugin()}onAfterFilter(t){t.forEach((e,o,s)=>{t[o].column=this.colHeaders[t[o].column]}),this.filters={filters:t};var e=new s(Object.assign(this.order,this.filters)).string();this.http.get("/data"+e).then(t=>{this._loadData(t)})}onAfterColumnMove(t,e){var o={columns:t,target:e};this.http.post("/aftercolumnmove",o)}onAfterCreateCol(t,e,o){var s={index:t,amount:e,source:o};this.http.post("/aftercreatecol",s).then(t=>{var e=t.colIndex;this.colHeaders=t.colOrder,console.log("value",t);var o=this.hot.getData();console.log("hotData",o),console.log(this.colHeaders);for(let t=0;t<o.length;t++)console.log(o[t][e]),console.log("row_id:",t),console.log("this.colHeaders[createdColId]",this.colHeaders[e]),this.hot.setCellMeta(t,e,"row_id",t),this.hot.setCellMeta(t,e,"col_id",this.colHeaders[e])})}onAfterCreateRow(t,e,o){var s={index:t,amount:e,source:o};this.http.post("/aftercreaterow",s).then(t=>t)}onAfterColumnSort(t,e){this.order=void 0!==e?{column:this.colHeaders[t],order:e}:{};let o=new s(Object.assign(this.order,this.filters));this.http.get("/data"+o.string()).then(t=>{this._loadData(t)})}_loadData(t){let e=t.data,o=[];for(let t=0;t<e.length;t++){let s=[];for(let o in e[t])s.push(e[t][o]);o.push(s)}this.hot.loadData(o);let s=[];for(let t in e[0])s.push(t);this.colHeaders=s,console.log("response",t),console.log("responseData",e),console.log("columnNames",s);for(let o=0;o<e.length;o++)for(let r=0;r<s.length;r++)this.hot.setCellMeta(o,r,"row_id",e[o][t.rowId]),this.hot.setCellMeta(o,r,"col_id",s[r])}onAfterInit(){this.http.get("/settings").then(t=>{this.hot.updateSettings(t.data)}),this.http.get("/data").then(t=>{this._loadData(t)})}disablePlugin(){super.disablePlugin()}updatePlugin(){this.disablePlugin(),this.enablePlugin(),super.updatePlugin()}onAfterChange(t,e){if(t){let o=[];for(let e=0;e<t.length;e++){let s=this.hot.getCellMeta(t[e][0],t[e][1]),r={row:s.row_id,column:s.col_id,oldValue:t[e][2],newValue:t[e][3],meta:s};delete r.meta.instance,o.push(r)}this.http.post("/afterchange",{changes:o,source:e})}}destroy(){super.destroy()}}e.default=i;Handsontable.plugins.registerPlugin("DataSourceConnector",i)}]).default});
//# sourceMappingURL=datasource-connector.js.map